<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Using Google's Captcha V3 with Express and Node</title>
    <!-- Tailwind CSS Browser Build -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@tailwindcss/typography@0.4.0/dist/typography.min.css"
    />
  </head>
  <body class="bg-gray-100 text-gray-900 antialiased">
    <!-- Header -->
    <header class="bg-gradient-to-r from-gray-300 to-gray-200 text-gray-800">
      <div
        class="max-w-6xl mx-auto px-6 py-4 flex flex-col sm:flex-row items-center justify-between"
      >
        <h1 class="text-3xl font-bold">
          <a href="/">Quick Thoughts</a>
        </h1>
        <nav class="mt-4 sm:mt-0">
          <ul class="flex flex-wrap space-x-4">
            
          </ul>
        </nav>
      </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-6xl mx-auto px-6 py-8"><article
  class="max-w-2xl mx-auto my-12 bg-white shadow-lg rounded-xl overflow-hidden"
>
  <!-- Post Header -->
  <header class="bg-gradient-to-r from-blue-300 to-blue-600 p-8 text-white">
    <h1 class="text-4xl font-extrabold tracking-tight">Using Google's Captcha V3 with Express and Node</h1>
    <p class="mt-2 text-base">
      Published on
      <time datetime="2023-03-05">
        March 05, 2023
      </time>
      
        in 
        
          <a
            href="/categories/development"
            class="inline-block ml-1 px-2 py-0.5 bg-blue-700 rounded text-xs font-medium hover:bg-blue-800"
          >
            development
          </a>
          , 
        
          <a
            href="/categories/opinion"
            class="inline-block ml-1 px-2 py-0.5 bg-blue-700 rounded text-xs font-medium hover:bg-blue-800"
          >
            opinion
          </a>
          , 
        
      
    </p>
  </header>

  <!-- Post Content -->
  <div class="prose max-w-none p-8"><p>Before getting started, <a href="https://quickthoughts.ca/development/degoogle/2020/12/16/using-hcaptcha-in-vue-instead-of-google.html">check out the newer version of this article</a> where I implement hCaptcha with express/Vue. hCaptcha is a non-google dependent captcha service. Otherwise, enjoy.</p>

<p>Building an anonymous user-facing technology is risky! Abuse, and spam are likely, along with potential DOS and other security/performance issues abound. Hence, <a href="https://developers.google.com/recaptcha/">Google ReCaptcha</a> - a wide-spread (everyone uses it), intelligent (it’s a lot more versatile than before) way to help limit spam from otherwise exposed forms.</p>

<p>Captcha systems are very common in today’s internet with websites demanding clarity on species (robot or human) before providing anything useful. And it makes sense, non-validated users (i.e. webcrawlers, bots, spiders, etc) can easily abuse services, reducing resources for meaningful clients. Google’s latest version is especially useful in that it grades the quality of the user on a scale (0 - 1), allowing for judgement of quality to be determined by the client.</p>

<p>It also can grade users without any user interaction - no more clicking “I’m not a robot.” buttons during checkout or form submission! A seamless integration means legitimate users no longer have to be burdened by puzzle-esque questionnaires. So yeah, all in all, it’s a good start at validating interactions on forms (although there’s plenty more one can do to limit spam).</p>

<h2 id="integrating-google-recaptcha-v3-with-an-express-application">Integrating Google ReCaptcha V3 with an Express application</h2>

<p>The <a href="https://developers.google.com/recaptcha/docs/v3">documentation</a> provided by Google is reasonably helpful - but an actual example is better!</p>

<h3 id="the-frontend-setup">The Frontend setup!</h3>

<p>First, add the correct ReCaptcha <code class="language-plaintext highlighter-rouge">&lt;script /&gt;</code> to your client-side-facing template (Load it earlier enough to provide enough data for a more accurate response). Something like:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;script </span><span class="na">src=</span><span class="s">"https://www.google.com/recaptcha/api.js?render=_reCAPTCHA_site_key&amp;onload=onLoad&amp;render=explicit"</span><span class="nt">&gt;&lt;/script&gt;</span>
</code></pre></div></div>

<p>Next, configure how you want the script to inject itself into the form you wanted guarded. I add the callback function in the script’s <code class="language-plaintext highlighter-rouge">src</code> to inject the captcha value into the form.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">onLoad</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">grecaptcha</span><span class="p">.</span><span class="nf">ready</span><span class="p">(</span><span class="nf">function </span><span class="p">()</span> <span class="p">{</span>
    <span class="nx">grecaptcha</span>
      <span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">captchaToken</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="p">{</span> <span class="na">action</span><span class="p">:</span> <span class="dl">"</span><span class="s2">submit</span><span class="dl">"</span> <span class="p">})</span>
      <span class="p">.</span><span class="nf">then</span><span class="p">(</span><span class="nf">function </span><span class="p">(</span><span class="nx">token</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Find the hidden input element in the form I wanted validated</span>
        <span class="kd">let</span> <span class="nx">t</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="dl">"</span><span class="s2">#reCaptcha</span><span class="dl">"</span><span class="p">);</span>
        <span class="c1">// give it a value returned by ReCaptcha</span>
        <span class="nx">t</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">token</span><span class="p">;</span>
      <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p><br /></p>
<pre><code class="language-HTML">    &lt;form&gt;
        &lt;!-- Other form stuff --&gt;
        &lt;input id="reCaptcha" type="hidden" name="g-recaptcha-response"&gt;
    &lt;/form&gt;
</code></pre>

<p>All in all, all that’s happening is the script loads, calls the function, injects a reCaptcha token into the form that we can validate against on the server. Simple stuff!</p>

<h3 id="setting-up-the-backend">Setting up the Backend</h3>

<p>We need to be able to parse the form, grab the token value, and then shoot out a call to the reCaptcha service and see if the submitted form can be trusted.</p>

<p>In Express, a simple middleware that can parse and shootout a request to the service is just what the Doctor ordered. It provides a portable way to pick and choose which routes need to be validated, and allows an easy way to reject requests.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">function</span> <span class="nf">verifyRecaptcha</span><span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">,</span> <span class="nx">next</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">captchaURL</span> <span class="o">=</span> <span class="s2">`https://www.google.com/recaptcha/api/siteverify`</span><span class="p">;</span>
  <span class="c1">// Get the token from the form</span>
  <span class="kd">const</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="dl">"</span><span class="s2">g-recaptcha-response</span><span class="dl">"</span><span class="p">];</span>

  <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">key</span><span class="p">)</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Captcha could not be verified. Please try again.</span><span class="dl">"</span><span class="p">);</span>

  <span class="c1">// axios works in Node, isn't that nice?</span>
  <span class="nf">axios</span><span class="p">({</span>
    <span class="na">url</span><span class="p">:</span> <span class="nx">captchaURL</span><span class="p">,</span>
    <span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>
    <span class="c1">// reCaptcha demands x-www-form-urlencoded requests</span>
    <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="na">ContentType</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/x-www-form-urlencoded</span><span class="dl">"</span> <span class="p">},</span>
    <span class="na">body</span><span class="p">:</span> <span class="s2">`secret=</span><span class="p">${</span><span class="nx">SECRET</span><span class="p">}</span><span class="s2">&amp;response=</span><span class="p">${</span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">[</span><span class="dl">"</span><span class="s2">g-recaptcha-response</span><span class="dl">"</span><span class="p">]}</span><span class="s2">`</span><span class="p">,</span>
  <span class="p">})</span>
    <span class="p">.</span><span class="nf">then</span><span class="p">((</span><span class="nx">captchaRes</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">captchaRes</span><span class="p">.</span><span class="nx">data</span><span class="p">;</span>
      <span class="c1">// check if successfully requested, and that a score over .5 is met</span>
      <span class="k">if </span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">success</span> <span class="o">===</span> <span class="kc">true</span> <span class="o">&amp;&amp;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">score</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">)</span> <span class="p">{</span>
        <span class="nf">next</span><span class="p">();</span>
      <span class="p">}</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nc">Error</span><span class="p">(</span><span class="dl">"</span><span class="s2">Captcha could not be verified. Please try again.</span><span class="dl">"</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nf">next</span><span class="p">(</span><span class="nx">error</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The function grabs the token from the form, shoots a POST request to reCaptcha, and then checks if its successful and returns a high enough score to continue on to the next step.</p>

<p>A route looks very familiar.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">router</span><span class="p">.</span><span class="nf">route</span><span class="p">(</span><span class="dl">"</span><span class="s2">/login</span><span class="dl">"</span><span class="p">,</span> <span class="nx">verifyRecaptcha</span><span class="p">).</span><span class="nf">get</span><span class="p">(</span><span class="nx">handleRoute</span><span class="p">);</span>
</code></pre></div></div>

<p>And that’s it! A really straightforward way to provide some protection and judge user interactions.</p>
</div>

  <!-- Post Footer -->
  <footer class="bg-gray-50 p-8 border-t">
    
      <div class="text-sm text-gray-600">
        <span class="font-semibold">Tags:</span>
        
          <a
            href="/tags/express"
            class="inline-block ml-2 px-3 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100"
          >
            express
          </a>
          ,
        
          <a
            href="/tags/captcha"
            class="inline-block ml-2 px-3 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100"
          >
            captcha
          </a>
          ,
        
          <a
            href="/tags/node"
            class="inline-block ml-2 px-3 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100"
          >
            node
          </a>
          ,
        
          <a
            href="/tags/web-development"
            class="inline-block ml-2 px-3 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100"
          >
            web-development
          </a>
          ,
        
          <a
            href="/tags/programming"
            class="inline-block ml-2 px-3 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100"
          >
            programming
          </a>
          ,
        
          <a
            href="/tags/opinion"
            class="inline-block ml-2 px-3 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100"
          >
            opinion
          </a>
          
        
      </div>
    
  </footer>
</article>
</main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white">
      <div class="max-w-6xl mx-auto px-6 py-4 text-center">
        <p class="text-sm">
          &copy; 2025 Quick Thoughts. All rights
          reserved.
        </p>
      </div>
    </footer>
  </body>
</html>
